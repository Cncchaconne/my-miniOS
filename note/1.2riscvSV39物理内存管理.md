# SV39物理内存管理

在S特权级下，我们需要通过操作satp寄存器来确定是否使用分页
satp寄存器如下：

|bits    |  63-60    | 59-44    |43-0       |
|  ----  | ----      | ----     | ----      |
|        | MODE(WARL)|   ASID   | PPN       |
|        | 4bit      |16bit     | 44bit     |

- MODE 控制CPU哪种页表实现
- ASID 表示地址空间标识符，涉及到进程
- PPN 存储的根页表所在的物理地址

地址的格式和组成

**virtual Address （39bits）**
|bits    |  38-12    | 11-0     |
|  ----  | ----      | ----     |
|        | Virtual Page Number|   Page offset  |

- 4096的大小就刚刚好是12bits

**Physical Address （56bits）**
|bits    |  55-12    | 11-0     |
|  ----  | ----      | ----     |
|        | Physical Page Number|   Page offset  |

地址转换是以页为单位进行的，在地址转换的前后地址页内偏移部分不变
从虚拟地址取出27位虚拟页号，在页表忠查到对应的物理页号
最后将物理页号和虚拟地址偏移成56为虚拟地址

页表中间虚拟页号可以查询一组保护位，称为页表项（PTE）

## 物理内存操作
- 如果一个机器申请一块内存，我们当然是将一块空闲的页丢给他
- 许多操作系统都用链表来管理空闲的页块
链表的头指针指向第一个页块，第二个页块指向第三个页块，就可以将没有使用的空页串联起来了，其实对物理内存的管理本质上就是对链表的操作

**一张页表的大小刚好是一张物理页的大小！！**

PTE 中记录的就是物理页号

