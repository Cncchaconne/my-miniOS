# 从物理地址到虚拟地址

在操作系统上，为了让其他程序页能够方便地运行在操作系统上，需要完成一个很重要的抽象是：让每一个程序都有字节的地址空间，并且地址空间的范围是一样的

这个地址空间就是虚拟内存！由虚拟地址到物理地址的映射交个操作系统来完成！

然而并不是只有操作系统来进行操作，硬件也会参与这些映射，这个机制就是页表。


## SV39 页表实现

虚拟地址39位有效，规定63-39位的值必须要等于第38位的值，否则该虚拟内存不合法。
VPN：visual page number 

**在SV39中采用多级页表实现**
将27位虚拟页号分为三个等长的部分，作为三级索引

则我们可以得到虚拟地址（VPN2，VPN1，VPN0，offset）

**virtual Address in SV39（39bits）**
|bits    |  38-30    | 29-21     | 20-12 | 11-0     |
|  ----  | ----      | ----      | ----  | ----     |
|        | VPN[2]    |   VPN[1]  | VPN[0]|page offset|

**一张页表的大小刚好是一张物理页的大小！！**

PTE 中记录的就是物理页号

a visual address
（VPN2，VPN1，VPN0，offset）

- 将基页的地址从satp中读取出来
- VPN2 作为偏移在三级页表的物理页中找到二级页表的物理页号
- VPN1 作为偏移在二级页表的物理页中找到一级页表的物理页号
- VPN0 作为偏移在一级页表的物理页中找到要访问位置的物理页号

## 等值映射
- 等值映射就是虚拟地址的值和物理地址的值相等。在未分页的时候，访问的是物理地址。然而在分页后，监管者模式和用户模式下访问的是虚拟地址，所以我们需要等值映射才能保证程序能够正常映射。
- 一切硬件部分都需要等值映射